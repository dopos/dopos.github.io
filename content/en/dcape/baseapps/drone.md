---
title: "drone"
date: 2020-01-30T00:38:25+09:00
description: Test description
draft: false
weight: 4
---

# Deploy with Drone


## Как это работает

Приложения (собственные исходные тексты или файлы конфигурации стороннего ПО) размещаются в репозитории на github.com или аналогичном сервисе (может использоваться встроенное приложение **gitea**, или собственный аналогичный сервис).

Для поддержки среды **dcape** репозиторий должен содержать файлы:
* `docker-compose.yml` - конфигурация сервисов docker, используемых для сборки и запуска приложений
* `Makefile` с командами создания файла конфигурации запуска `.env`, подготовки окружения приложения (БД и прочее), запуском сервисов через docker-compose

Разворачивание приложения производится командой `make start-hook`, которая путем исполнения целей из `Makefile`, подготавливает запуск приложения, финальной целью является запуск docker-compose с использованием переменных конфигурации запуска из файла `.env`. Инициирование запуска `make start-hook` производится вебхуком сервиса git, при использовании промышленного или облачного сервера с **dcape**. Если **dcape** используется локально - разворачивание приложения осуществляется командой `make start`, запускаемой в терминале.

Файл `.env` c переменными для `docker-compose.yml` и другими переменными для запуска приложения не размещается в репозитории, при первом деплое он создается командой `make .env` и сохраняется вебхуком в Хранилище конфигураций (enfist). После этого, доступ к конфигурации запуска приложения осуществляется через это хранилище. Для каждой ветки репозитория создается своя конфигурация запуска.

Настройка **dcape**, для разворачивания приложения, состоит из двух шагов:
1. Настроить автоматическое обновление (webhook) в репозитории проекта
2. Поместить в хранилище конфигураций запуска приложения файл `.env` с разрешением на деплой (`_CI_HOOK_ENABLED=yes`)

После этого push в репозиторий проекта будет приводить к разворачиванию/обновлению приложения в среде **dcape**.
См. также: [DEPLOY.md](DEPLOY.md).
Для локального использования **dcape** такая настройка не требуется.