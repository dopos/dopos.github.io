---
title: "traefik"
date: 2020-01-30T00:38:25+09:00
description: Test description
draft: false
weight: 1
---

# Конфигурация traefik


## Использование TLS
Dcape поддерживает протокол TLS с использованием ключей [Let's Encrypt](https://ru.wikipedia.org/wiki/Let%E2%80%99s_Encrypt).
При инициализации Dcape, поддержку TLS можно сконфигурировать четырьмя способами:
* `local mode` - локальная установка, использование DCAPE на локальном компьютере без поддержки TLS.
* `dev mode` - установка с использованием TLS с отдельным сертификатом для каждого приложения, использование которых настраивается конкретно для приложения при его развертывании. По умолчанию включено для встроенных приложений dcape (cis, portainer, gitea). В этом режиме используется переменная `REDIR_ENTRY`, которой устанавливается редирект на https отдельно для каждого приложения. В других режимах значение этой переменной не определено и не используется.
* `wild mode` - установка для деплоя приложений с возможностью использования TLS c wilcards сертификатом от Let's Encrypt для всех веб сервисов dcape и приложений (позволяет не опасаться ограничения по лимиту количества сертификатов на один домен).
* `production mode` - установка с использованием индивидуальных сертификатов Let's Encrypt для каждого веб сервиса.

Dcape поддерживает автоматическую генерацию сертификатов и валидацию домена для индивидуальных сертификатов.
Для wildcards сертификатов, автоматическая генерация сертификатов и валидация доменов поддерживается для DNS
[провайдеров](https://docs.traefik.io/configuration/acme/#provider) с поддержкой API.
По умолчанию, при инициализации, конфигурируется автоматизированная генерация (перегенерация) сертификатов, при которой автоматически запускается генерация сертификата, в лог файл выдается хеш, который необходимо
внести в поле домена, тип `TXT`, имя `_acme-challenge.$DOMAIN`, значение `хеш из лога` .
Wildcards генерируется для домена: `*.$DOMAIN`, где DOMAIN="домен для которого разворачивается DCAPE"

Для перехода на автоматический wild-mode необходимо:
- изменить в директиве `APPS` сервис traefik-acme на treafik-acme-wild
- в `.env` добавить директивы DNS_CHALLENGE_PROVIDER и DNS_CHALLENGE_RESOLVER
- в `apps/traefik-acme-wild/docker-compose.inc.yml` в секции environment указать соответствующие вашему провайдеру наименования API_KEY/API_URL по примеру PDNS
- выполнить make reup для DCAPE.

В случае не запуска traefik-acme-wild смотреть логи контейнера. Контейнер не будет запускаться, если упущены обязательные настройки.

В период настройки во избежание бана со стороны Letsencrypt рекомендуется использовать директиву `ACME_CASERVER`=https://acme-staging-v02.api.letsencrypt.org/directory
для работы через тестовый канал (выписывается Fake сертификат), а после полной отладки механизма, выкл `ACME_CASERVER`.
