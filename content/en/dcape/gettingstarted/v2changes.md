---
title: "Отличия dcape v2"
description: "Отличия dcape версии 2 от версии 1"
date: 2020-01-28T00:34:41+09:00
draft: false
weight: 6
---

**Dcape** v2 отличается от v1:
* переездом деплоя на drone
* сменой версии traefik на v2.
* добавлением локально создаваемого образа `dcape-compose`

Подробнее об изменениях:

## Версия traefik

* *Было:* 1.7
* *Стало:* 2.0

В результате изменились

### Настройки в docker-compose

Теперь для привязки настроек к контейнеру необходимо в имя добавлять уникальное имя приложения для всех приложений, работающих с одной копией traefik. Для этого добавлен параметр `APP_TAG`, который может быть рассчитан автоматически по hostname ресурса. Этот же параметр можно использовать как префикс всех контейнеров приложения (значение ключа `-p` команды `docker-compose`)

#### Поддержка TLS

Теперь для добавления TLS достаточно добавить в блок `labels` файла `docker-compose.yml` строку вида

```docker-compose.yml
    - traefik.http.routers.${APP_TAG}.tls=${USE_TLS}
```

Кроме этого, поддержка wildcard-domain теперь доступна "из коробки" и реализована дополнительным сервисом (powerdns) которым traefik управляет через АПИ.

### Авторизация для приватных ресурсов

Ранее осуществлялась через API gitea, теперь gitea выступает OAuth2-сервером. Это добавило необходимость регистрировать в gitea приложения (narra, drone) и разрешать их использование для каждого пользователя.

## dcape-compose

* [Dockerfile](https://github.com/dopos/dcape/blob/v2/apps/drone/Dockerfile)

## Сервис развертывания

* *Было:* webhook + webtail с командами `make start-hook` и `make update` (make использует /bin/bash)
* *Стало:* drone и .drone.yml (make использует /bin/sh)

## Удаление деплоя

Основным способом для остановки контейнера и удаления образа теперь является portainer.
