---
title: "Приложения"
description: "Адаптация приложения для развертывания в среде dcape"
date: 2020-01-28T00:36:14+09:00
weight: 1
draft: false
---

## Введение

Dcape v2 предназначен для построения gitops (CI/CD) решений, в которых на каждом сервере установлен **dcape** и на одном - web-сервис git (например: gitea), который по факту изменений в репозитории активирует **drone** на присоединенных серверах.

После развёртывания сервисов git/drone, задача dcape уже решена, но возникает возможность добавить в деплой:

* [docker-compose.yml](https://github.com/dopos/dcape/blob/v2/apps/drone/dcape-app/docker-compose.yml)
* [Makefile](https://github.com/dopos/dcape/blob/v2/apps/drone/dcape-app/Makefile)

Эти файлы могут использоваться при развёртывании приложений. [Пример использования](https://github.com/dopos/dcape-app-gomodproxy)


## Алгоритм настройки

Настройка **dcape** для разворачивания приложения состоит из следующих шагов:

* создать репозиторий (или зеркало) в gitea
* активировать репозиторий в drone целевого сервера
* выполнить `git push` (или тест вебхука)
* отредактировать конфигурацию и сохранить ее под именем без суффикса `.sample`
* повторить `git push` (или тест вебхука) - приложение будет развернуто на целевом сервере

После этого push в репозиторий проекта будет приводить к разворачиванию/обновлению приложения в среде **dcape**.

Для развертывания приложения в среде **dcape**, оно должно поддерживать интеграцию с тремя подсистемами:

* [traefik](/dcape/baseapps/traefik)
* [drone](/dcape/baseapps/drone)
* [enfist](/dcape/baseapps/enfist)

Ниже описаны примеры такий интеграции

## Интеграция с traefik

Производится с помощью меток контейнера.

### Пример docker-compose.yml

{{< source "static/samples/docker-compose.yml" >}}

#### Пояснения по строкам

* [8](/dcape/usage/apps/#static/samples/docker-compose.yml-8): активация traefik для контейнера
* [9](/dcape/usage/apps/#static/samples/docker-compose.yml-9): привязка контейнера к конкретному экземпляру traefik

## Интеграция с drone

Производится с помощью файла `.drone.yml`, который размещается в корне репозитория.

### Пример .drone.yml

{{< source "static/samples/.drone.yml" >}}

#### Пояснения по строкам

* [10](/dcape/usage/apps/#static/samples/.drone.yml-10): использовать для развертывания образ `dcape_drone-compose` (создается при установке **dcape**)
* [12](/dcape/usage/apps/#static/samples/.drone.yml-12): интеграция с enfist
* [13](/dcape/usage/apps/#static/samples/.drone.yml-13): создание персистентного каталога
* [14](/dcape/usage/apps/#static/samples/.drone.yml-14): запуск drone-compose

## Интеграция с enfist

enfist - это сервис хранения файлов конфигурации, которые в dcape имеют имя `.env`. Соответственно, приложение должно уметь работать с конфигурацией, размещенной в таком файле. В части переменных, используемых в `docker-compose.yml`, формат файла должен соответствовать [docker-compose env_file](https://docs.docker.com/compose/compose-file/compose-file-v2/#env_file).

Файл `.env` c переменными для `docker-compose.yml` и другими переменными для запуска приложения не размещается в репозитории, работа с ним при деплое осуществляется командой [setup config](/dcape/usage/apps/#static/samples/.drone.yml-12):

* если в enfist нет конфигурации для текущей комбинации "организация-репозиторий-ветка", выполняется `make .env.sample` (если в репозитории нет .env.sample) и полученный файл сохраняется в enfist с именем "организация-репозиторий-ветка.sample"
* иначе - конфигурация из enfist выгружается в файл .env

Для каждой ветки репозитория создается своя конфигурация запуска.

## Обновление и удаление развернутого приложения

В случае, если префикс (`DCAPE_TAG`) и имя (`APP_TAG`) приложения не изменились - контейнер будет остановлен и удален обновлении приложения. В остальных случаях управление контейнерами и образами может прибыть произведено через portainer

## См. также

* [Актуальный список адаптированных приложений dcape](https://github.com/dopos?q=dcape-app)
