---
title: "Приложения"
description: "Адаптация приложения для развертывания в среде dcape
"
date: 2020-01-28T00:36:14+09:00
weight: 4
draft: false
---


Для развертывания приложений в среде **dcape** v2 используется drone c образом docker-compose (создается при установке dcape).

## См. также

* [Deploy with Drone](https://github.com/dopos/dcape/tree/v2/apps/drone)
* [Адаптированные для dcape приложения](https://github.com/dopos?q=dcape-app)
* [dcape-config-cli](https://github.com/dopos/dcape-config-cli) - утилита для работы (загрузки,выгрузки, изменения) с конфигурациями запуска в среде **dcape**
* [Актуальный список адаптированных приложений dcape](https://github.com/dopos?q=dcape-app)

## Управление конфигурациями запуска приложений

Конфигурация запуска любого приложения **dcape** - текстовый файл `.env`, который создается командой `make .env`.
Этот файл используется `make start-hook` для разворачивания приложения и [docker-compose](https://docs.docker.com/compose/) для управления контейнерами приложения.
В части переменных, используемых в `docker-compose.yml`, формат файла должен соответствовать [docker-compose env_file](https://docs.docker.com/compose/compose-file/compose-file-v2/#env_file).

Конфигурации запуска приложений хранятся в БД в виде Key-value хранилища, где ключ формируется из адреса git репозитория `organization--name_of_repo--branch` (`организация--проект--ветка`), а значение - содержимое `.env` файла. Доступ к хранилищу закрыт паролем и осуществляется через фронтенд **cis**.

Кроме веб-интерфейса, работа с конфигурациями запуска может осуществляться через [dcape-config-cli](https://github.com/dopos/dcape-config-cli).
Примеры команд, доступных после клонирования (git clone) и настройки (make .env) dcape-config-cli:

* `make get TAG=name` - получить из хранилища конфигурацию для тега `name` и сохранить в файл `name.env`
* `make set TAG=name` - загрузить файл `name.env` в хранилище с тегом `name`

Тег содержит значение равное ключу БД Key-value хранилища `organization--name_of_repo--branch` (`организация--проект--ветка`)




## Необходимые данные, для деплоя приложения под dcape (dcape развернут на dev.lan)

* хост dcape, если приложение создает www сервис, то в переменной 'Makefile' APP_SITE указывается имя доступа к сервису (например, aplication.dev.lan)
* публичный ключ развертывания деплоя (доступен по ссылке на cis.dev.lan)
* пароль, который должен быть передан в хуке (задан в конфиге dcape)

## Порядок действий по адаптации приложения
### Вариант с ипользованием встроенного gitea, dcape развернут на хосте: dev.lan

* Cоздать зеркало в gitea (если репозиторий размещен не на встроенном gitea), репозиторий в gitea должен быть приватным, для использования ssh ключа.
* Составить и добавить в репозиторий файлы `Makefile` и `docker-compose.yml` ([примеры](https://github.com/dopos?q=dcape-app))
* настроить в gitea "Автоматическое обновление"
* выполнить тестовую доставку webhook для выполнения `make .env` (сохранения .env в хранилище конфигураций)
* выгрузить конфигурацию, активировать деплой в параметре `_CI_HOOK_ENABLED`, сохранить (утилита  )
* повторить тестовую доставку webhook или сделать `git push` - приложение будет развернуто на сервере dcape

### Настройка автоматического обновления в gitea

* добавить ключ развертывания деплоя (доступен по ссылке на cis.dev.lan)
* создать хук gitea с паролем из настроек dcape и ссылкой на хук
  * URL хука: если gitea и dcape на одном хосте - `http://webhook:9000/hooks/local?branch=default`, иначе - `https://cis.dev.lan/hooks/remote?branch=default`
    * события хука: Push, Create

Параметр `branch=default` позволяет произвести деплой копии приложения без внесения изменений в репозиторий проекта.
Если изменить default на нужное имя ветки и тега, то можно выполнить удаление деплоя.

См. также: [Описание алгоритма деплоя](https://github.com/dopos/dockerfile-webhook/blob/master/webhook/README.md)

## Информация для разработчика

### Отличия локальной копии dcape от сервера деплоя

Локально можно развернуть полный аналог iac (в dcape есть gitea - его можно развернуть, настроить как upstream, туда пушить и наблюдать локально весь процесс деплоя).
А если локальный ip доступен снаружи, можно завести dcape на порт 80 и включить https.

Т.е. отличие только в том, что не получится использовать по https те же доменные имена, что и на сервере, т.к. у локального хоста другой ip.

### Если в Makefile изменили шаблон создания .env

Чтобы сгенерить новый `.env`, не потеряв настройки из старого, надо старый переименовать в `.env.bak` и выполнить `make .env` - значения совпадающих переменных будут перенесены в новый конфиг.

Это достигается помещением в Makefile строк
```
-include $(CFG).bak
-include $(CFG)
export
```

### Удаление деплоя

Чтобы удалить на сервере контейнер и каталог деплоя проекта для репозитория `organization--name_of_repo--branch` (`организация--проект--ветка`), надо создать ветку `organization--name_of_repo--branch`.
Другой вариант - если в проект никто не пушит, можно в хуке поменять default на BRANCH-rm и выполнить "Проверить доставку", после чего вернуть default.

Реакция хука на создание ветки с суффиксом "-rm" - выполнить `make stop` и удалить каталог деплоя (конфиг сохраняется).
