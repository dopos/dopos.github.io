---
title: "drone"
date: 2020-01-30T00:38:25+09:00
description: деплой приложений по событию из gitea
draft: false
weight: 4
---

 Приложение | [drone](https://github.com/drone)
 -- | --
 Docker | [image](https://hub.docker.com/r/drone/drone)
 Назначение | деплой приложений по событию из gitea

## Как это работает

* Приложения (собственные исходные тексты или файлы конфигурации стороннего ПО) размещаются в репозитории на github.com или аналогичном сервисе управления git-репозиториями (может использоваться встроенное приложение **gitea**, или собственный аналогичный сервис).
* При установке drone указывается адрес сервиса управления git-репозиториями
* В интерфейсе drone активируется нужный git-репозиторий
* При пуше коммита в репозиторий, сервис управления активирует webhook всех подключенных копий drone
* Webhook drone клонирует репозиторий и выполняет инструкции из файла .drone.yml

## Особенности

* если контейнеру надо монтировать каталоги, при активации в drone репозиторию надо поставить флаг `Trusted` (это может сделать пользователь, указанный в параметре `DRONE_ADMIN`, в пртивном случае этому пользователю будет отправлен запрос на разрешение)
* при установке drone в dcape создается контейнер `dcape_drone-compose`, который может быть использован для старта контейнеров
* кроме `dcape_drone-compose`, контейнер `dcape_drone-compose` включает утилиту setup, которая поддерживает 2 команды:
  * config - создание или скачивание конфигурации приложения из enfist
  * root - создание каталога на хостовой системе и помещение пути к нему в переменную `APP_ROOT`

## Пример .drone.yml

См [.drone.yml](https://github.com/dopos/dcape-app-nginx-sample/blob/v2/.drone.yml)

## Дополнения

Как правило, приложение в среде **dcape** содержит файлы:

* `Makefile` с командами
  * `${CFG}.sample` - создание файла конфигурации запуска для размещения его в enfist (используется в `setup config`)
  *  `.drone-up` - старт контейнера, используется в `.drone.yml`
* `docker-compose.yml` - конфигурация сервисов docker, используемых для сборки и запуска приложений, с инструкциями для интеграции с traefik

Файл `.env` c переменными для `docker-compose.yml` и другими переменными для запуска приложения не размещается в репозитории, при первом деплое он создается командой `make .env.sample` и сохраняется вебхуком в Хранилище конфигураций (enfist). После этого, доступ к конфигурации запуска приложения осуществляется через это хранилище. Для каждой ветки репозитория создается своя конфигурация запуска.

Настройка **dcape** для разворачивания приложения состоит из следующих шагов:

* создать репозиторий (или зеркало) в gitea
* активировать репозиторий в drone целевого сервера
* выполнить push (или тест вебхука) - командой `setup config` в БД enfist сервера попадет пример конфигурации
* отредактировать конфигурацию и сохранить ее под именем без суффикса `.sample`
* повторить push (или тест вебхука) - приложение будет развернуто на целевом сервере

После этого push в репозиторий проекта будет приводить к разворачиванию/обновлению приложения в среде **dcape**.
