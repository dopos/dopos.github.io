[{"content":"Введение Dcape предназначен для построения gitops (CI/CD) решений, в которых на каждом сервере установлен dcape и на одном - web-сервис git (например: gitea), который по факту изменений в репозитории активирует drone на присоединенных серверах.\nПосле развёртывания сервисов git/drone, задача dcape уже решена, но возникает возможность добавить в деплой:\nMakefile.app для использования в директиве include файла Makefile адаптируемого приложения (чтобы не дублировать цели) docker-compose.app.yml для использования в качестве основы для override в адаптируемом приложении Эти файлы добавляются в образ dcape-compose, поэтому доступны и на хостовой системе и при развёртывании. Для работы с ними в Makefile приложения надо добавить директивы:\n1 2 3 4 5 6 7 8 9 10 # ------------------------------------------------------------------------------ # Find and include DCAPE_ROOT/Makefile DCAPE_COMPOSE ?= dcape-compose DCAPE_ROOT ?= $(shell docker inspect -f \u0026#34;{{.Config.Labels.dcape_root}}\u0026#34; $(DCAPE_COMPOSE)) ifeq ($(shell test -e $(DCAPE_ROOT)/Makefile.app \u0026amp;\u0026amp; echo -n yes),yes) include $(DCAPE_ROOT)/Makefile.app else include /opt/dcape/Makefile.app endif Это позволяет\nне дублировать в make такие цели, как dc, db-create, .drone-default директивой USE_DB=yes добавлять в .env настройки БД и активировать команды db-* директивой ADD_USER=yes добавлять в .env настройки учетной записи пользователя использовать docker-compose.app.yml в цели dc как основу для перезаписи. См. также: Пример использования\nАлгоритм настройки Первое развёртывание приложения в среде dcape состоит из следующих шагов:\nсоздать репозиторий (или зеркало) в gitea активировать репозиторий в drone целевого сервера выполнить git push (или тест вебхука) - drone произведет попытку развёртывания, в результате которой будет создан файл .env и сохранен в enfist с ключом org--repo_name--branch.sample отредактировать конфигурацию и сохранить ее под именем без суффикса .sample повторить деплой в drone или тест вебхука - приложение будет развернуто на целевом сервере После этого push в репозиторий проекта будет приводить к разворачиванию/обновлению приложения в среде dcape.\nДля развертывания приложения в среде dcape, оно должно поддерживать интеграцию с тремя подсистемами:\ntraefik woodpecker enfist Ниже описаны примеры такий интеграции\nИнтеграция с traefik Производится с помощью меток контейнера.\nПример docker-compose.yml 1 2 3 4 5 6 7 8 9 10 11 # custom app config # overrides DCAPE/apps/drone/dcape-app/docker-compose.yml version: \u0026#39;2\u0026#39; services: app: environment: - VAR=value volumes: - ${APP_ROOT}/html:/usr/share/nginx/html:ro Интеграция с woodpecker Производится с помощью файла .woodpecker.yml, который размещается в корне репозитория.\nПример .drone.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 --- kind: pipeline type: docker name: app steps: - name: deploy_local pull: never image: ${DCAPE_COMPOSE} commands: - . setup config - make .drone-default volumes: - name: dockersock path: /var/run/docker.sock volumes: - name: dockersock host: path: /var/run/docker.sock Пояснения по строкам 10: использовать для развертывания образ dcape-compose (создается при установке dcape) 12: интеграция с enfist 13: подготовка окружения и запуск docker-compose Подготовка окружения создание персистентного каталога\nИнтеграция с enfist enfist - это сервис хранения файлов конфигурации, которые в dcape имеют имя .env. Соответственно, приложение должно уметь работать с конфигурацией, размещенной в таком файле. В части переменных, используемых в docker-compose.yml, формат файла должен соответствовать docker-compose env_file.\nФайл .env c переменными для docker-compose.yml и другими переменными для запуска приложения не размещается в репозитории, работа с ним при деплое осуществляется командой setup config:\nесли в enfist нет конфигурации для текущей комбинации \u0026ldquo;организация-репозиторий-ветка\u0026rdquo;, выполняется make .env.sample (если в репозитории нет .env.sample) и полученный файл сохраняется в enfist с именем \u0026ldquo;организация-репозиторий-ветка.sample\u0026rdquo; иначе - конфигурация из enfist выгружается в файл .env Для каждой ветки репозитория создается своя конфигурация запуска.\nОбновление и удаление развернутого приложения В случае, если префикс (DCAPE_TAG) и имя (APP_TAG) приложения не изменились - контейнер будет остановлен и удален обновлении приложения. В остальных случаях управление контейнерами и образами может прибыть произведено через portainer\nСм. также Актуальный список адаптированных приложений dcape ","description":"Адаптация приложения для развертывания в среде dcape","id":0,"section":"dcape","tags":null,"title":"Приложения","uri":"https://dopos.github.io/dcape/usage/apps/"},{"content":"Цель создания dcape - получить относительно удобный способ запуска docker-приложений простой короткой командой, например\nmake up - локально git push - удаленно Главная проблема была в том, как повесить несколько контейнеров на порт 80, чтобы запросы к ним проксировались по имени хоста не на основании заранее руками созданного конфига, а по факту старта контейнера - эту задачу решил traefik.\nБонусом он добавил TLS, т.е. возможность получения сертификата для хоста или, когда хостов много - для домена (т.е. wildcard-домена)\nПри использовании traefik приложение может управлять своей доступностью извне посредством меток (label) docker-контейнера, задавать которые можно в файле docker-compose.yml\nПроект dcape - это попытка достичь требуемых целей с помощью traefik, docker-compose и минимального количества дополнительного кода.\n","description":"Какие задачи решает проект","id":1,"section":"dcape","tags":null,"title":"Назначение","uri":"https://dopos.github.io/dcape/purpose/"},{"content":"В случае, если уже\nнастроен DNS c поддержкой wildcard-record есть сервер gitea (в примере - it.domain.tld) в gitea создан TOKEN на новом сервере установлены зависимости , установка dcape на этом новом сервере может быть произведена так:\n1 2 3 4 5 6 7 8 9 git clone --depth 1 https://github.com/dopos/dcape.git cd dcape make install ACME=wild DNS=wild DCAPE_DOMAIN=srv1.domain.tld \\ TRAEFIK_ACME_EMAIL=admin@domain.tld \\ NARRA_GITEA_ORG=dcape \\ DRONE_ADMIN=lekovr \\ PDNS_LISTEN=192.168.23.10:53 \\ GITEA=https://it.domain.tld \\ TOKEN=**token_from_gitea** В PDNS_LISTEN порт изменен на стандартный (по умолчанию: 54) и задан ip, чтобы не возникало конфликта с локальным резолвером.\n","description":"Как развернуть dcape, если уже есть gitea и DNS","id":2,"section":"dcape","tags":null,"title":"Быстрый старт","uri":"https://dopos.github.io/dcape/gettingstarted/quickstart/"},{"content":" Repo: dcape-app-template\nupstream_name application package for dcape.\nUpstream Project: upstream_name Docker: template Requirements linux 64bit with git, make, sed installed docker with compose plugin dcape v3 VCS service like Gitea CI/CD service like Woodpecker CI Install Via CI/CD VCS: Fork or mirror this repo in your Git service CI/CD: Activate repo VCS: \u0026ldquo;Test delivery\u0026rdquo;, config sample will be saved to config service (enfist in dcape) Config: Edit config vars and remove .sample from config name VCS: \u0026ldquo;Test delivery\u0026rdquo; again (or CI/CD: \u0026ldquo;Restart\u0026rdquo;) - app will be installed and started on CI/CD host After that just change source and do git push - app will be reinstalled and restarted on CI/CD host Via terminal Run commands on deploy host with dcape installed:\n1 2 3 4 5 git clone https://github.com/dopos/dcape-app-template.git cd dcape-app-template make config-if ... \u0026lt;edit .env\u0026gt; make up ","description":"Шаблон приложения для dcape v3","id":3,"section":"dcape","tags":null,"title":"App template","uri":"https://dopos.github.io/dcape/addons/app-template/"},{"content":" Repo: dcape-app-traefik\nРоль в dcape Сервис Docker images router traefik traefik Назначение Агрегация и проксирование www-сервисов развернутых приложений по заданному имени с поддержкой сертификатов Let\u0026rsquo;s Encrypt\nTraefik - ключевой сервис dcape. Он решает следующие задачи:\nпри запуске контейнера проанализировать его метки (label) и добавить контейнер в систему проксирования внешних http(s) запросов, определяя целевой контейнер по имени хоста если конфигурацией предусмотрена работа через TLS - проверить наличие сертификата и, при необходимости, получить или обновить его через сервис Let\u0026rsquo;s Encrypt Особенности Варианты файла конфигурации В составе dcape есть три варианта файла конфигурации traefik:\ntraefik.local.yml - использование DCAPE на локальном компьютере без поддержки TLS traefik.acme-http.yml - https с получением сертификатов по протоколу HTTP-01 traefik.acme.yml - https с получением сертификатов по протоколу HTTP-01 и DNS-01 (для поддержки wildcard-доменов) При выполнении команды make apply, по значению параметра ACME определяется вариант конфигурации и соответствующий файл копируется в var/traefik/traefik.yml с заменой переменных (если его еще нет).\nОграничение видимости контейнеров Для того, чтобы конкретный экземпляр traefik отреагировал на запуск контейнера, в конфигурации контейнера надо указать две метки:\n1 2 3 labels: - traefik.enable=true - dcape.traefik.tag=${DCAPE_TAG} Если не задана первая из этих меток, контейнер не будет виден никакому экземпляру traefik. Значение второй метки позволяет запустить на одном хосте несколько экземпляров traefik и привязывать контейнер только к тому экземпляру, у которого совпадает значение DCAPE_TAG.\nТакая функциональность обеспечивается следующими настройками traefik:\n1 2 3 4 providers: docker: exposedByDefault: false constraints: Label(`dcape.traefik.tag`,`=DCAPE_TAG=`) Поддержка wildcard-доменов Dcape поддерживает протокол TLS с использованием ключей Let\u0026rsquo;s Encrypt.\nДля получения сертификатов по протоколу DNS-01 необходим доступ к АПИ сервера DNS. В состав dcape для этого включен сервер powerdns. Если параметр ACME имеет значение wild, при выполнении команды make apply создается файл var/traefik/traefik.env с настройками для доступа к АПИ локальной копии powerdns\nНастройки контейнера для работы с TLS Ниже в примерах использованы следующие параметры конфигурации:\nAPP_TAG - уникальный тег контейнера, может формироваться автоматически из значения APP_SITE USE_TLS - использовать TLS APP_SITE - основной hostname контейнера APP_ACME_DOMAIN - wildcard-домен контейнера HTTP-01, индивидуальные сертификаты 1 2 3 labels: - traefik.http.routers.${APP_TAG}.tls=${USE_TLS} - traefik.http.routers.${APP_TAG}.tls.certresolver=letsEncrypt DNS-01, wildcard-домен 1 2 3 4 5 labels: - traefik.http.routers.${APP_TAG}.tls=${USE_TLS} - traefik.http.routers.${APP_TAG}.tls.certresolver=letsEncrypt - traefik.http.routers.${APP_TAG}.tls.domains[0].main=${APP_SITE} - traefik.http.routers.${APP_TAG}.tls.domains[0].sans=${APP_ACME_DOMAIN} Тестирование Файл конфигурации traefik включает строку\n1 # caServer: \u0026#34;https://acme-staging-v02.api.letsencrypt.org/directory\u0026#34; В период настройки, во избежание бана со стороны Letsencrypt, рекомендуется ее раскомментировать для работы через тестовый канал (выписывается Fake сертификат), а после полной отладки механизма, удалить.\nНесколько копий dcape на одном сервере dcape позволяет запуск нескольких экемпляров на одном сервере, для этого они должны использовать разные порты. Поэтому TLS с обновлением сертификатов будет доступен только тому экземпляру, который слушает порт 443.\nДля запуска второго экземпляра необходимо разместить его в другом каталоге (или использовать другие значения параметров CFG, DCAPE_VAR) и изменить в его настройках:\nпорты в параметрах TRAEFIK_LISTEN и TRAEFIK_LISTEN_SSL параметр DCAPE_TAG ","description":"агрегация и проксирование www-сервисов развернутых приложений по заданному имени с поддержкой сертификатов Let\u0026#39;s Encrypt","id":4,"section":"dcape","tags":null,"title":"router","uri":"https://dopos.github.io/dcape/coreapps/router/"},{"content":"При деплое через CI/CD В сервисе управления конфигурациями отредактировать настройки приложения, изменив параметр IMG_VER В сервисе управления исходниками повторно выполнить тестовую доставку При деплое через терминал В каталоге, где развернуто приложение дикейп, изменить параметр IMG_VER в файле .env Выполнить команду make up ","description":"Алгоритм обновления приложений дикейп","id":5,"section":"dcape","tags":null,"title":"Обновление","uri":"https://dopos.github.io/dcape/apps/update/"},{"content":"Если dcape был установлен командой git clone, для его обновления используется команда git pull, после выполнения которой необходимо обновить файл .env\nОбновление файла .env При обновлении проекта возможно появление новых переменных в .env файле.\nАлгоритм обновления .env с сохранением старых настроек:\n1 2 mv .env .env.bak make init Другой вариант:\n1 2 mv .env .env.1019 make init CFG_BAK=.env.1019 Все совпадающие значения будут взяты из .env.bak (т.е. из старого конфига).\nЕсли изменятся номера версий используемых docker-образов сервисов dcape, будут выведены предупреждения.\nОбновление версий сервисов Для того, чтобы обновить все номера версий используемых docker-образов сервисов dcape, сохранив остальные настройки, надо подготовить .env.bak, убрав из него номера версий:\n1 2 3 grep -v \u0026#34;_VER=\u0026#34; .env \u0026gt; .env.bak mv .env .env.pre make init Резервирование .env в enfist Настройки dcape/.env не сохраняются в enfist автоматически, но это можно сделать вручную:\n1 2 ln -s .env dcape.env make env-set TAG=dcape Восстановление сервисов из резервной копии dcape-app-pg-backup предназначен для ежедневного создания резервных копий баз данных, которые сохраняются в /opt/dcape/var/db/backup. Кроме такой копии, для восстановления сервиса необходимо перенести соответствующий каталог из /opt/dcape/var/ (с сохранением владельца файлов).\nПример команды восстановления БД:\n1 2 3 make gitea-apply PG_SOURCE_SUFFIX=-210212 # или make db-create NAME=GITEA PG_SOURCE_SUFFIX=-210212 При восстановлении надо учитывать следующее\nБД загружается из дампа только при ее создании, т.е. предварительно надо ее удалить, если она есть в копии файлов обычно есть конфиг, в котором задан пароль к БД (пример для gitea - /opt/dcape/var/gitea/gitea/conf/app.ini), этот пароль должен совпадать с тем, который указан в .env PG_SOURCE_SUFFIX используется для формирования имени дампа так: ${DCAPE_DB_DUMP_DEST}/${GITEA_DB_TAG}${PG_SOURCE_SUFFIX}.tgz, поэтому если имя БД и префикс архива не совпадают, архив надо переименовать ","description":"Обновление dcape и версий сервисов dcape","id":6,"section":"dcape","tags":null,"title":"Обновление","uri":"https://dopos.github.io/dcape/usage/update/"},{"content":"Развертывание dcape имеет результатом 2 файла - docker-compose.yml и .env, которые позволяют командой make up запустить весь стек выбранных для конкретного сервера приложений. Все эти приложения доступны на dockerhub и все нужное для их запуска командой docker-compose up может быть подготовлено вручную, однако dcape добавляет в процесс подготовки такого решения следующие возможности:\nфайл параметров (.env) формируется программно, что позволяет использовать в значениях переменные генерировать необходимые приложениям пароли и токены формировать взаимосвязанные настройки приложений файл конфигурации контейнеров (docker-compose.yml) формируется программно, что позволяет параметризовать список приложений для каждой инсталляции, в частности если разворачивается группа серверов различного назначения, gitea достаточно развернуть только на одном из них, а на остальных вместо make init выполнять make init GITEA=https://git.domain.tld если для сервера не нужен SSL (например, в локальной сети), не указывать параметр ACME если для сервера не нужен DNS (например, wildcard сертификаты не используются или их поддержка не использует локальный DNS), не указывать параметр DNS Использование make позволяет перед стартом приложения выполнять его инициализацию, включая\nсоздание БД (и, при необходимости, загрузку дампа БД) формирование файлов конфигураций по шаблонам регистрацию OAuth2 приложений ","description":"Почему выбран make","id":7,"section":"dcape","tags":null,"title":"Результат работы","uri":"https://dopos.github.io/dcape/features/"},{"content":"Зависимости linux 64bit с git, make, sed, curl, jq docker docker-compose используется в dcape в формате docker-образа, поэтому отдельной установки не требует.\nПример установки зависимостей:\ndocker 1 2 3 4 curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - sudo add-apt-repository \u0026#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\u0026#34; sudo apt install docker-ce docker-ce-cli containerd.io sudo usermod -a -G docker $USER См. также: Install docker\nmake, git, sed, curl, jq 1 sudo apt install make git sed curl jq ","description":"Приложения, необходимые для установки dcape","id":8,"section":"dcape","tags":null,"title":"Зависимости","uri":"https://dopos.github.io/dcape/gettingstarted/dependencies/"},{"content":" Repo: dcape-app-postgres\nРоль в dcape Сервис Docker image db postgresql / Citus postgres / citus Назначение Размещение баз данных приложений, которым требуется СУБД.\nСУБД postgresql используется следующими сервисами dcape:\ngitea woodpecker enfist powerdns Кроме этого, контейнер доступен для других приложений, развертываемых под dcape.\nОсобенности Размещение файлов Постоянные данные контейнера размещаются в каталоге var/db в следующих подкаталогах:\ndata - внутренние файлы postgresql init - скрипты, которые выполняются при старте контейнера backup - размещение дампов баз для импорта/экспорта conf.d - каталог дополнений в конфигурацию, активируется вручную параметром include_dir файла postgresql.conf shared - каталог для размещения расширений перед их ручной активацией Резервные копии Для резервного копирования баз данных используется приложение pg-backup которое по заданному в настройках расписанию делает дампы указанных в настройках баз и размещает их в формате .tgz в каталоге var/db/backup\nCitus Для использования citisdb вместо postgresql, достаточно в .env\nуказать параметры образа\n# Postgresql docker image DB_IMAGE=citusdata/citus # Postgresql docker image version DB_VER=postgres_15 и подключить расширение\nDB_LIB_PREFIX=citus См. также Tuning tools pgconfig TimescaleDB tuning tool pgtune pgCenter support (make pgtop) ","description":"хранение конфигураций всех приложений и размещение баз данных приложений, которым требуется СУБД","id":9,"section":"dcape","tags":null,"title":"db","uri":"https://dopos.github.io/dcape/coreapps/db/"},{"content":" Repo: dcape-app-nginx-sample\nNGINX sample application package for dcape.\nDocker image used nginx Features This project contains\nreference versions of core files for all of dcape applications since dcape v2: Makefile .drone.yml dcape-compose.yml samples for some nginx features: log real user\u0026rsquo;s ip from traefik data send gzipped static files custom error pages Requirements linux 64bit (git, make, sed) docker dcape v3 Git service (github, gitea or gogs) Install By mouse (deploy with drone) Gitea: Fork or mirror this repo in your Git service Drone: Activate repo Gitea: \u0026ldquo;Test delivery\u0026rdquo;, config sample will be saved to enfist Enfist: Edit config and remove .sample from name Gitea: \u0026ldquo;Test delivery\u0026rdquo; again (or Drone: \u0026ldquo;Restart\u0026rdquo;) - app will be installed and started on webhook host By hands 1 2 3 4 5 6 git clone --depth 1 https://github.com/dopos/dcape-app-nginx-sample.git cd dcape-app-nginx-sample make config ... \u0026lt;edit .env.sample\u0026gt; mv .env.sample .env make up Upgrade 1 2 3 4 5 git pull make config ... \u0026lt;check .env.sample\u0026gt; mv .env.sample .env make up ","description":"Пример nginx приложения","id":10,"section":"dcape","tags":null,"title":"Nginx sample app","uri":"https://dopos.github.io/dcape/addons/nginx-sample/"},{"content":"Через CI/CD В сервисе управления исходниками сделать форк или зеркало этого проекта Активировать полученный репозиторий в CI/CD В сервисе управления исходниками выполнить тестовую доставку, она отработает с ошибкой, но в сервисе управления конфигурациями (в dcape это enfist) будет создан пример конфигурации. В сервисе управления конфигурациями отредактировать настройки приложения и удалить .sample в имени настроек В сервисе управления исходниками повторно выполнить тестовую доставку - сервис будет развернут и запущен After that just change source and do git push - app will be reinstalled and restarted on CI/CD host Через терминал На целевом сервере после установки dcape выполнить команды\n1 2 3 4 5 git clone https://github.com/dopos/dcape-app-enfist.git cd dcape-app-enfist make config-if ... \u0026lt;edit .env.sample\u0026gt; make up ","description":"Инсталляция приложения дикейп","id":11,"section":"dcape","tags":null,"title":"Установка","uri":"https://dopos.github.io/dcape/apps/install/"},{"content":"Т.к. dcape разворачивает несколько независимых сервисов, их имена должны быть зарегистрированы в DNS. Предпочтительным является вариант регистрации wildcard DNS record, но можно и регистрировать индивидуально.\nПример имен для сервера srv1.domain.tld:\nsrv1.domain.tld - для фронтендов narra, enfist, traefik git.srv1.domain.tld - для gitea drone.srv1.domain.tld - для drone port.srv1.domain.tld - для portainer ns.srv1.domain.tld - для powerdns /etc/hosts Вариант для случая, когда dcape разворачивается и используется на локальном компьютере, в т.ч. если у этого компьютера нет сетевых интерфейсов.\nТ.к. сервисы dcape общаются между собой, их hostname нельзя привязать к loopback- интерфейсу. В качестве ip-адреса можно использовать шлюз подсети dcape, которая задается параметром DCAPE_SUBNET (по умолчанию, подсеть - 100.127.0.0/24 и шлюз - 100.127.0.1):\n1 2 grep -q \u0026#34; dev.lan\u0026#34; /etc/hosts || \\ sudo bash -c \u0026#39;for n in \u0026#34;\u0026#34; git drone port ns ; do [ \u0026#34;$n\u0026#34; ] \u0026amp;\u0026amp; n=\u0026#34;$n.\u0026#34; ; echo \u0026#34;100.127.0.1 ${n}dev.lan\u0026#34; \u0026gt;\u0026gt; /etc/hosts ; done\u0026#39; dnsmasq В случае использования локальной сети, когда известен ip-адрес компьютера с dcape (в примере - 192.168.1.2) и установлен DNS-сервер dnsmasq, можно создать локальный wildcard-domain:\n1 2 sudo bash -c \u0026#39;echo \u0026#34;address=/.dev.lan/192.168.1.2\u0026#34; \u0026gt; /etc/NetworkManager/dnsmasq.d/dev.lan.conf\u0026#39; sudo service network-manager reload DNS зона При наличии доступ к управления DNS-сервером и если хост с dcape имеет внешний ip-адрес (в примере - 19.72.10.23), имена могут быть зарегистрированы одним из следующих способов:\nиндивидуальная регистрация srv1.domain.tld. A 19.72.10.23 git.srv1.domain.tld. A 19.72.10.23 cicd.srv1.domain.tld. A 19.72.10.23 port.srv1.domain.tld. A 19.72.10.23 ns.srv1.domain.tld. A 19.72.10.23 wildcard DNS record srv1.domain.tld. A 19.72.10.23 *.srv1.domain.tld. A 19.72.10.23 wildcard DNS record с делегированием зоны В процессе регистрации wildcard сертификатов traefik производит изменения в DNS-зоне через АПИ DNS-сервера. Чтобы не давать ему доступ к основной DNS-зоне, можно для каждого сервера создать выделенную зону (в примере - srv1.domain.tld) и директивой CNAME делегировать управление сертификатами этой зоны отдельному серверу (в примере - серверу ns.srv1.domain.tld, т.е. локальному DNS). Используемая в dcape v2 версия traefik это уже поддерживает.\nsrv1.domain.tld. A 19.72.10.23 *.srv1.domain.tld. A 19.72.10.23 acme-srv1.domain.tld. NS ns.srv1.domain.tld _acme-challenge.srv1.domain.tld. CNAME acme-srv1.domain.tld _acme-challenge.*.srv1.domain.tld. CNAME acme-srv1.domain.tld Команда инициализации dcape для этого примера:\n1 2 3 make init ACME=wild DNS=wild DCAPE_DOMAIN=srv1.domain.tld \\ TRAEFIK_ACME_EMAIL=admin@domain.tld \\ PDNS_LISTEN=19.72.10.23:53 В PDNS_LISTEN порт изменен на стандартный (по умолчанию: 54) и задан ip, чтобы не возникало конфликта с локальным резолвером.\nСм. также: настройка связки taefik-powerdns для DNS=wild\n","description":"Варианты настройки DNS","id":12,"section":"dcape","tags":null,"title":"Настройка DNS","uri":"https://dopos.github.io/dcape/gettingstarted/dns/"},{"content":" Repo: dcape-app-pg-backup\nPostgresql database backup application package for dcape v3.\nDocker image used dcape v1: none (used running dcape_db container) dcape v2: internally built image with name stored in ${DCAPE_COMPOSE} drone var dcape v3: dcape-compose (cron uses running dcape_db container) Requirements linux 64bit (git, make, wget, gawk, openssl) docker dcape v3 Git service (github, gitea or gogs) Usage Fork this repo in your Git service Setup deploy hook Run \u0026ldquo;Test delivery\u0026rdquo; (config sample will be created in dcape) Edit and save config (enable deploy etc) Run \u0026ldquo;Test delivery\u0026rdquo; again (app will be installed and started on webhook host) See also: Deploy setup (in Russian)\nDirect run If installed via CI/CD\ndocker exec -ti pg-backup-cron-1 bash -c \u0026#39;cd /root \u0026amp;\u0026amp; /etc/periodic/daily/pgbackup.sh\u0026#39; For custom database\ndocker exec -it pg-backup-cron-1 bash -c \u0026#34;make -f /root/Makefile backup DB_NAME=pdns\u0026#34; If installed locally\nmake backup ","description":"Резервное копирование баз postgresql","id":13,"section":"dcape","tags":null,"title":"PG Backup","uri":"https://dopos.github.io/dcape/addons/pg-backup/"},{"content":" Repo: dcape-app-gitea\nРоль в dcape Сервис Docker images vcs gitea gitea Назначение Git совместимый сервис для работы с репозиториями (если используется несколько серверов, разворачивается только на одном)/\nGitea - это сервис управления git-репозиториями, который поддерживает\nинтеграцию с сервисом развертывания приложений woodpecker интеграцию с narra по протоколу OAuth2 ","description":"git-совместимый сервис для работы с репозиториями","id":14,"section":"dcape","tags":null,"title":"vcs","uri":"https://dopos.github.io/dcape/coreapps/vcs/"},{"content":" Repo: dcape\nDcape - это инструмент для развёртывания docker-приложений по технологии GitOps, который с помощью make и docker-compose, позволяет решить следующие задачи:\nкомандами make up запускать приложения, использующие общий порт (например 80) БД командой git push удаленно разворачивать приложения на одном или нескольких компьютерах через АПИ или web-интерфейс управлять конфигурациями приложений ограничивать заданной группой пользователей доступ к интерфейсам управления используемым ПО обслуживать работу с letsencrypt сертификатами wildcard-доменов управлять инфраструктурой docker Dcape представляет собой набор Makefile и настроек, позволяющий подготовить и развернуть на сервере комплекс согласованных между собой приложений.\nDcape не является постоянно работающим сервисом.\nПриложения Для решения поставленных задач могут быть использованы docker-образы следующих приложений:\nобщий порт - traefik БД - postgresql удаленно разворачивать приложения - Woodpecker CI (на каждом компьютере) и на каком-то одном - gitea (или аналог) управлять конфигурациями - enfist ограничивать доступ - narra, в качестве группы пользователей используется организация gitea wildcard-домены - powerdns управлять инфраструктурой docker - portainer Зачем dcape? Все эти приложения распространяются независимо от dcape и могут быть развернуты самостоятельно.\nПри этом, в процессе деплоя может потребоваться выполнить\nсобственную настройку приложения (БД, первичные данные\u0026hellip;) настройку взаимодействия (адреса для запросов, ключи доступа\u0026hellip;) В максимальном варианте процесс настройки всего комплекса приложений включает задание значений для ~90 параметров. В dcape это количество уменьшено до 3х для некоторых конфигураций.\nПримерную схему взаимодействий между приложениями можно посмотреть тут\nDcape позволяет упростить процесс развертывания следующим образом\nмногие параметры можно рассчитать на основе уже известных для определения значений параметра можно вызвать внешнюю программу (например, KEY ?= $(shell openssl rand -hex 16; echo)) для определения значений параметра и кода можно использовать программные конструкции (например, ifneq ($(AUTH_TOKEN),)) make позволяет любой параметр переопределить в строке вызова инструменты dcape доступны при деплое других приложений (см dcape-app-template ) исходный код dcape с учетом настроек всех 8 сервисов - это 10 Makefile, всего 485 строк 17 YAML, всего 502 строки Документация См. dopos.github.io/dcape\nЗависимости linux + sudo apt -y install git make sed curl jq docker + sudo apt -y install docker-compose-plugin Примеры использования Запуск приложения локально Требования:\nкомпьютер с linux, docker и dcape зарегистрированные (в /etc/hosts или внутреннем DNS) имена для ip компьютера (например - mysite.dev.test, www.mysite.dev.test) Пример для статического сайта и nginx 1 2 3 4 5 git clone https://github.com/dopos/dcape-app-nginx-sample.git cd dcape-app-nginx-sample make config-if # \u0026lt;edit .env\u0026gt; make up Все готово - http://mysite.dev.test/ и http://www.mysite.dev.test/ запущены.\nЗапуск приложения удаленно Диаграмма первичного развертывания Диаграмма обновления приложения Установка dcape Требования:\nкомпьютер с linux, docker и установленными зависимостями зарегистрированный в DNS для ip этого компьютера wildcard-домен (например - *.srv1.domain.tld) Конфигурация с локальным gitea 1 2 3 4 5 6 7 8 9 MY_HOST=demo.dcape.ru MY_IP=${MY_IP:-192.168.23.10} LE_ADMIN=admin@dcape.ru git clone https://github.com/dopos/dcape.git cd dcape make install ACME=wild DNS=wild DCAPE_DOMAIN=${MY_HOST} \\ TRAEFIK_ACME_EMAIL=${LE_ADMIN} PDNS_LISTEN=${MY_IP}:53 make echo-gitea-admin-pass Конфигурация с удаленным gitea Дополнительные требования для регистрации приложений на удаленном gitea\n$AUTH_TOKEN для gitea API 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 MY_HOST=${MY_HOST:-srv1.domain.tld} LE_ADMIN=${LE_ADMIN:-admin@domain.tld} GITEA_URL=${GITEA_URL:-https://git.domain.tld} GITEA_ORG=${GITEA_ORG:-dcape} GITEA_USER=${GITEA_USER:-dcapeadmin} git clone https://github.com/dopos/dcape.git cd dcape make install ACME=wild DNS=wild DCAPE_DOMAIN=${MY_HOST} \\ TRAEFIK_ACME_EMAIL=${LE_ADMIN} \\ NARRA_GITEA_ORG=${GITEA_ORG} \\ CICD_ADMIN=${GITEA_USER} \\ PDNS_LISTEN=${MY_IP}:53 \\ GITEA=${GITEA_URL} \\ AUTH_TOKEN=${AUTH_TOKEN} make echo-gitea-admin-pass Все готово - сервер srv1.domain.tld готов к деплою приложений, интерфейсы приложений dcape доступны по адресу https://srv1.domain.tld.\nИспользование Команды (targets) Makefile. Актуальный список: make[ help].\nGit commands git-% run git for every app. Sample: make git-status-s Docker-compose commands build-compose create docker-compose image ps show stack containers up (re)start container(s) up-% start container reup-% restart container reup restart container(s) down stop (and remove) container(s) Database commands psql exec psql inside db container db-create create database and user db-drop drop database and user psql-docker exec psql inside db container from apps. Example: make psql-docker DCAPE_STACK=yes psql-local run local psql from apps. Example: make psql-local DCAPE_STACK=yes PGPORT=5433 App config storage commands env-get get env tag from store, `make env-get TAG=app--config--tag` env-ls list env tags in store env-set set env tag in store, `make env-set TAG=app--config--tag` OAuth2 setup oauth2-org-create create VCS org via VCS API oauth2-app-create create OAuth2 app via VCS API .env operations config generate sample config config-force generate sample config and rename it to .env config-if generate sample config and rename it to .env if not exists Other echo-% print config var. Sample: make echo-gitea-admin-pass clean-noname delete unused docker images w/o name (you should use portainer for this) clean-volume delete docker dangling volumes (you should use portainer for this) help list Makefile targets (this is default target) Переменные Имя По умолчанию Описание DCAPE_DOMAIN dev.test dcape containers hostname domain DCAPE_ROOT $(PWD) dcape root directory DCAPE_TAG dcape container name prefix DCAPE_ADMIN_USER dcapeadmin CICD_ADMIN - CICD admin user\nGITEA_ADMIN_NAME - Gitea admin user name DCAPE_ADMIN_ORG dcape VCS OAuth app owner group\n* NARRA_GITEA_ORG - user group with access to auth protected resources\n* config oauth app owner\n* CICD oauth app owner APPS - dcape apps\ncalculated by install\nused in make only ","description":"Ядро dcape","id":15,"section":"dcape","tags":null,"title":"Ядро dcape","uri":"https://dopos.github.io/dcape/core/"},{"content":"Исходники Рекомендуемым способом копирования файлов на сервер является выполнение git clone. Это позволяет в будущем\nобновить исходники для получения информации о проверенных новых версиях используемых приложений увидеть локальные изменения исходников, если их понадобится сохранить 1 2 3 4 cd /opt sudo mkdir dcape \u0026amp;\u0026amp; sudo chown $USER dcape git clone --depth 1 https://github.com/dopos/dcape.git cd dcape Настройка и запуск Локальный сервер Вариант без поддержки SSL, но с установкой gitea. Выполняется в 3 шага, т.к. на шаге 2 необходимо использовать браузер для\nзавершения установки gitea создания API TOKEN Шаг 1. Подготовка к запуску gitea 1 2 3 make init DCAPE_DOMAIN=srv1.domain.tld make apply make up Шаг 2. Запуск и настройка gitea открыть GITEA_URL, нажать \u0026ldquo;вход\u0026rdquo; - откроется страница параметров установки ввести логин и пароль учетной записи (логин должен совпадать со значением DRONE_ADMIN) создать токен (Настройки -\u0026gt; Приложения -\u0026gt; Генерировать токен) Шаг 3. Запуск dcape 1 2 make gitea-setup TOKEN=... make up TOKEN - ключ АПИ gitea, который создается вручную пользователем, имеющим права на создание\nорганизации, указанной в параметре NARRA_GITEA_ORG (если она не создана ранее) OAuth2 приложений narra и woodpecker (их CLIENT_ID и CLIENT_KEY будут сохранены в .env). TOKEN используется однократно при выполнении make gitea-setup и нигде не сохраняется\nСм. также: Issue 22, Автоматизировать первичную настройку Gitea\nПримеры make init 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # сервер для локального использования make init # изменение локального порта, по которому будет доступен postgresql (по умолчанию: 5433): make init PG_PORT_LOCAL=5434 # посмотреть .env без сохранения изменений make init CFG=tmp$$ DCAPE_VAR=tmp$$-var ACME=wild DNS=wild \u0026amp;\u0026amp; less tmp$$ \u0026amp;\u0026amp; rm -rf tmp$$* # сервер без gitea, с wildcard сертификатом make init ACME=wild DNS=wild DCAPE_DOMAIN=srv1.domain.tld \\ TRAEFIK_ACME_EMAIL=admin@domain.tld \\ PDNS_LISTEN=192.168.23.10:53 \\ NARRA_GITEA_ORG=dcape \\ DRONE_ADMIN=lekovr \\ GITEA=https://it.domain.tld Использование make up - старт приложений После выполнения этой команды все последующее администрирование среды и запущеных сервисов производится в www интерфейсе portainer.\nВместе с тем, в консоли доступны следующие команды:\nmake - список доступных команд make down - остановка и удаление всех контейнеров make dc CMD=\u0026quot;up -d enfist\u0026quot; - стартовать контейнер заданного приложения (если не запущен) make dc CMD=\u0026quot;rm -f -s enfist\u0026quot;- остановить и удалить контейнер enfist make dc CMD=\u0026quot;up -d --force-recreate enfist\u0026quot; - пересоздать и стартовать контейнер enfist и его зависимости make db-create NAME=ENFIST - создать в postgresql пользователя и БД из настроек enfist make db-drop NAME=ENFIST - удалить пользователя и БД из настроек enfist make apply PG_SOURCE_SUFFIX=-171014 - развернуть проект, используя резервную копию БД с заданным суффиксом , созданную pg-backup ","description":"Инструкция по установке","id":16,"section":"dcape","tags":null,"title":"Установка","uri":"https://dopos.github.io/dcape/gettingstarted/installation/"},{"content":" Repo: dcape-app-woodpecker\nРоль в dcape Сервис Docker images cicd Woodpecker CI server, agent Назначение Деплой приложений при получении webhook от VCS.\nКак это работает Приложения (собственные исходные тексты или файлы конфигурации стороннего ПО) размещаются в репозитории на github.com или аналогичном сервисе управления git-репозиториями (может использоваться встроенное приложение gitea, или другой аналогичный сервис). При установке CI/CD указывается адрес сервиса управления git-репозиториями В интерфейсе CI/CD активируется нужный git-репозиторий При пуше коммита в репозиторий, сервис управления (VCS) активирует webhook всех подключенных экземпляров CI/CD Webhook CI/CD клонирует репозиторий и выполняет инструкции из .yml-файла в контексте сервиса, заданного параметром type. Этот сервис должен быть запущен вместе с CI/CD, в dcape в качестве такого сервиса используется CI/CD-runner-docker Особенности если контейнеру надо монтировать каталоги, при активации в CI/CD репозиторию надо поставить флаг Trusted (это может сделать пользователь, указанный в параметре CI/CD_ADMIN, в противном случае этому пользователю будет отправлен запрос на разрешение развертывания) при установке CI/CD в dcape создается образ dcape-compose, который может быть использован для развёртывания контейнеров кроме docker-compose и make, образ dcape-compose включает Makefile.app для использования в директиве include файла Makefile адаптируемого приложения (чтобы не дублировать цели) docker-compose.app.yml для использования в качестве основы для override в адаптируемом приложении Переменные среды CI/CD-docker-runner DCAPE_TAG - тег текущей копии dcape, значение из .env DCAPE_NET - имя сети dcape, значение из .env DCAPE_COMPOSE - имя образа dcape-compose для текущей копии dcape (префикс совпадает с DCAPE_TAG) DCAPE_ROOT - путь к каталогу var (/opt/dcape) хостовой системы, который у выполняющего Ci/CD контейнера примонтирован по этому же пути Пример сценария CI/CD См сценарий CI/CD для dcape-app-nginx-sample\nПричины выбора Woodpecker CI См. Step-by-step guide to modern, secure and Open-source CI setup, 2022.\n","description":"развёртывание приложений по событиям из gitea","id":17,"section":"dcape","tags":null,"title":"cicd","uri":"https://dopos.github.io/dcape/coreapps/cicd/"},{"content":" Repo: dcape-config-cli\nCommand line interface for dcape config storage enfist.\nDocker image used none (used connect to remote dcape config service) Requirements linux (git, make, curl, jq) Setup git clone https://github.com/dopos/dcape-config-cli.git make .env [write dcape attributes to .env] CIS access token доступен на сервере CIS после авторизации (для авторизации открыть ссылку \u0026ldquo;Config store\u0026rdquo; и обновить страницу)\nUsage make ls - получить список конфигураций на сервере make cat TAG=name - получить из хранилища конфигурацию для тега name и вывести на STDOUT make get TAG=name - получить из хранилища конфигурацию для тега name и сохранить в файл name.env make set TAG=name - загрузить файл name.env в хранилище с тегом name (возвращает true если создан новый конфиг) make del TAG=name - удалить в хранилище тег name (возвращает true если конфиг удален) TODO make push - сохранить все конфиги из текущего каталога на сервер деплоя make pull - выгрузить в текущий каталог все конфиги с сервера деплоя ","description":"CLI для доступа к файлам конфигурации","id":18,"section":"dcape","tags":null,"title":"Config CLI","uri":"https://dopos.github.io/dcape/addons/config-cli/"},{"content":"Dcape может быть развернут в конфигурации CLI-only, с минимальным набором контейнеров\nrouter (traefik) - реверс-прокси и сертификаты db (postgresql) - БД для приложений (не используется dcape) manager (portainer) - www-интерфейс для управления контейнерами (не используется dcape) при этом\nСертификаты LE обновляются через HTTP-1 (нет поддержки wildcard доменов) Доступ в traefik dashboard происходит по фиксированному паролю Далее описано, как получить такую конфигурацию в текущей версии dcape\n1 2 3 4 5 git clone --single-branch --depth 1 https://github.com/dopos/dcape.git cd dcape make install DNS=no AUTH_TOKEN=none AUTH_URL=none APPS_ALWAYS=manager \\ DCAPE_DOMAIN=host.example.com \\ ACME=yes TRAEFIK_ACME_EMAIL=admin@example.com Для доступа в traefik dashboard необходимо\nсгенерировать пароль 1 2 3 4 5 6 LOGIN=admin PASS=$(openssl rand -hex 16; echo) echo \u0026#34;Login: $LOGIN\u0026#34; echo \u0026#34;Password: $PASS\u0026#34; echo -n \u0026#34;HTPASS: \u0026#34; echo $(htpasswd -nb $LOGIN $PASS) | sed -e s/\\\\$/\\\\$\\\\$/g добавить в apps/_router/docker-compose.inc.yml после строки - \u0026#34;traefik.http.routers.dashboard.middlewares=narra\u0026#34; строку\n- \u0026#34;traefik.http.middlewares.narra.basicauth.users=\u0026lt;HTPASS\u0026gt;\u0026#34; выполнить make up После этого\ndcape будет развернут в составе: traefik, postgresql, portainer панель traefik будет доступна по адресу https://example.com/dashboard/ для учетной записи из п. \u0026ldquo;сгенерировать пароль\u0026rdquo; ","description":"Как развернуть dcape без gitea и DNS","id":19,"section":"dcape","tags":null,"title":"Минимальная конфигурация","uri":"https://dopos.github.io/dcape/gettingstarted/minimal/"},{"content":" Repo: dcape-app-enfist\nРоль в dcape Сервис Docker image config enfist app-enfist Назначение Enfist - это сервис хранения конфигураций приложений. Конфигурации хранятся в БД в виде Key-value таблицы, где ключ (key) формируется из адреса git репозитория organization--repo_name--branch (организация--проект--ветка), а значение (value) - содержимое .env файла.\nДоступ к хранилищу ограничивается narra и осуществляется через фронтенд dcape.\nКроме веб-интерфейса, работа с конфигурациями запуска может осуществляться посредством dcape-config-cli.\nПримеры команд, доступных после клонирования (git clone) и настройки (make .env) dcape-config-cli:\nmake get TAG=name - получить из хранилища конфигурацию для ключа (тега) name и сохранить в файл name.env make set TAG=name - загрузить файл name.env в хранилище с ключом (тегом) name Тег содержит значение, равное ключу БД Key-value хранилища: organization--name_of_repo--branch (организация--проект--ветка)\nВ файле конфигурации dcape-config-cli задается два параметра:\nENFIST_URL - адрес сервиса enfist CIS_TOKEN - токен для авторизации в gitea ","description":"интерфейс к хранилищу файлов конфигурации","id":20,"section":"dcape","tags":null,"title":"config","uri":"https://dopos.github.io/dcape/coreapps/config/"},{"content":" Repo: dcape-dns-config\nConfig for dcape based powerdns server\nThis project contains Makefile and sample sql zone definition for loading zones into PowerDNS server.\nRequirements linux 64bit (git, make, wget, gawk, openssl) docker dcape Git service (github, gitea or gogs) Usage fork this project into your dcape gitea in gitea project settings setup hook for server where powerdns service running clone project locally from gitea add your zones .sql by example from domain.sql.sample make git push and change project env in dcape cis config frontend make git push again and see updated dns zones TODO Zone rectification SQL ","description":"Управление зонами DNS в postgresql","id":21,"section":"dcape","tags":null,"title":"DNS Config","uri":"https://dopos.github.io/dcape/addons/dns-config/"},{"content":"Аргументы \u0026lsquo;make init\u0026rsquo; Благодаря использованию Makefile, любой параметр dcape может быть задан в аргументах команды make init.\nАктуальные значения параметров и их описания при выполнении этой команды сохраняются в файле с именем .env (или именем, заданном в параметре CFG).\nАктуальный для конкретного экземпляра dcape список параметров зависит от наличия добавленных сервисов.\nСледующие параметры имеют ключевое значение для конфигурации dcape:\nDCAPE_TAG Идентификатор стека приложений, позволяющий изолировать его от других контейнеров docker (в т.ч. и от другой копии стека dcape если такая будет запущена на том же сервере) Префикс контейнеров стека (значение используется как COMPOSE_PROJECT_NAME) DCAPE_DOMAIN hostname для сервисов narra, enfist, traefik суффикс по умолчанию для hostname остальных приложений стека GITEA значения: [yes]|\u0026lt;URL\u0026gt; yes - добавить в конфигурацию локальный сервис gitea \u0026lt;URL\u0026gt; - адрес внешнего сервера gitea DNS значения: [no]|yes|wild добавить в конфигурацию локальный сервис powerdns wild - настроить зону для поддержки wildcard сертификатов letsencrypt ACME значения: [no]|http|wild включить поддержку сертификатов letsencrypt no - адреса сервисов dcape будут начинаться с http://, иначе - https:// wild - в конфигурацию traefik будет добавлена поддержка сертификатов для домена *.${DCAPE_DOMAIN} NARRA_GITEA_ORG username организации gitea, участникам которой будет предоставлен доступ к приватным ресурсам DRONE_ADMIN username пользователя gitea, который получит права администратора в drone См. также Варианты файла конфигурации traefik ","description":"Параметры конфигурации","id":22,"section":"dcape","tags":null,"title":"Конфигурация","uri":"https://dopos.github.io/dcape/gettingstarted/configuration/"},{"content":" Repo: dcape-app-narra\nРоль в dcape Сервис Docker image auth narra ghcr.io/dopos/narra Назначение Сервис OAuth2 авторизации, который разрешает доступ к ресурсу только участникам заданной в настройках организации gitea.\nРесурсы dcape с ограниченным доступом фронтенд dcape - список развернутых на сервере приложений и сервисов настройки приложений dcape router dasboard статистика ns Подключение авторизации к приложениям dcape docker-compose.yml\n1 2 3 4 services: app: labels: - \u0026#34;traefik.http.routers.${APP_TAG}.middlewares=narra\u0026#34; # Require gitea auth ","description":"развёртывание приложений по событиям из gitea","id":23,"section":"dcape","tags":null,"title":"auth","uri":"https://dopos.github.io/dcape/coreapps/auth/"},{"content":"Dcape v2 отличается от v1:\nпереездом деплоя на drone сменой версии traefik на v2. добавлением локально создаваемого образа dcape-compose Подробнее об изменениях:\nВерсия traefik Было: 1.7 Стало: 2.0 В результате изменились\nНастройки в docker-compose Теперь для привязки настроек к контейнеру необходимо в имя добавлять уникальное имя приложения для всех приложений, работающих с одной копией traefik. Для этого добавлен параметр APP_TAG, который может быть рассчитан автоматически по hostname ресурса. Этот же параметр можно использовать как префикс всех контейнеров приложения (значение ключа -p команды docker-compose)\nПоддержка TLS Теперь для добавления TLS достаточно добавить в блок labels файла docker-compose.yml строку вида\n1 - traefik.http.routers.${APP_TAG}.tls=${USE_TLS} Кроме этого, поддержка wildcard-domain теперь доступна \u0026ldquo;из коробки\u0026rdquo; и реализована дополнительным сервисом (powerdns) которым traefik управляет через АПИ.\nАвторизация для приватных ресурсов Ранее осуществлялась через API gitea, теперь gitea выступает OAuth2-сервером. Это добавило необходимость регистрировать в gitea приложения (narra, drone) и разрешать их использование для каждого пользователя.\ndcape-compose Dockerfile Сервис развертывания Было: webhook + webtail с командами make start-hook и make update (make использует /bin/bash) Стало: drone и .drone.yml (make использует /bin/sh) Удаление деплоя Основным способом для остановки контейнера и удаления образа теперь является portainer.\n","description":"Отличия dcape версии 2 от версии 1","id":24,"section":"dcape","tags":null,"title":"Отличия dcape v2","uri":"https://dopos.github.io/dcape/gettingstarted/v2changes/"},{"content":" Repo: dcape-app-powerdns\nРоль в dcape Сервис Docker images ns PowerDNS ghcr.io/dopos/powerdns-alpine Назначение Wildcard-DNS для сертификатов LetsEncrypt Сервис DNS Сервис может быть развернут как отдельное приложение dcape.\n","description":"DNS-сервер для поддержки wildcard DNS сертификатов","id":25,"section":"dcape","tags":null,"title":"ns","uri":"https://dopos.github.io/dcape/coreapps/ns/"},{"content":" Repo: dcape-app-portainer\nРоль в dcape Сервис Docker image manager portainer portainer-ce Назначение Инструмент для управления инфраструктурой docker (образами, контейнерами, томами и т.д.) с помощью браузера.\nОн не используется никакими другими сервисами dcape и включен для удобства эксплуатации серверов.\n","description":"Web-интерфейс управления docker","id":26,"section":"dcape","tags":null,"title":"manager","uri":"https://dopos.github.io/dcape/coreapps/manager/"},{"content":" The format is based on Keep a Changelog\nand this project adheres to Semantic Versioning.\n[3.1.0] - 2024-05-27 Added compare local app versions with upstream \u0026amp; update local (make ver-cmp [ VER_UPDATE=yes]) debug for gitea exchange (including POST debug) Fixed APPS recurse CICD_ADMIN empty AUTH_URL, DCAPE_ADMIN_USER read APP_ROOT from .env standalone .config-link \u0026lsquo;version\u0026rsquo; is obsolete copyright years [3.0.2] - 2023-12-18 Added docs: Upgrade dcape v2 to v3 CHANGELOG.md DCAPE_NET_EXISTS DB_CONTAINER for apps ENFIST_BRANCH APP_ROOT_OPTS, .build Fixed host mount for cicd deploy\nnot use .env in build\npsql-local for app\ndev.lan -\u0026gt; dev.test\nimprove Serve flow\n.default-deploy improved\nhost mount for cicd deploy\npsql-local for app\ngrep .env if var not global\nupd: upgrade-v3, docs\nupd: dev.lan -\u0026gt; dev.test\nUpgrade git pull make git-pull make config-if mv .dcape.env.sample .dcape.env set DCAPE_NET_EXISTS=true make .env make build-compose make up [3.0.0] - 2023-08-01 Changed Move to docker compose plugin Replaced drone with woodpecker Separated core apps repos and configs, see dcape3-coreapp Improve dcape-app [2.2.1] - 2023-06-21 Fixed set HTTP_PROTO after include add PG_ADMIN var rm double labels add timezone psql-local via DSN [2.1.2] - 2022-03-30 Bump docker images:\ntraefik:2.6.2 gitea/gitea:1.16.5 drone/drone:2.11.1 drone/drone-runner-docker:1.8.0 portainer/portainer-ce:2.11.1-alpine ghcr.io/dopos/powerdns-alpine:v4.6.1 [2.1.1] - 2021-11-27 Fixed drone pipelines for non-amd64 drone runners postgresql backups: try .tar before .tgz support for docker-compose v1.28+ Upgrade git pull mv .env .env.bak make init make up [2.1.0] - 2021-11-17 Added own docker images placed at ghcr.io support for arm64 arch updated third-party apps versions [2.0.0] - 2021-01-28 own docker images placed at ghcr.io added support for arm64 arch updated third-party apps versions [1.1] - 2020-11-16 2 years in prod [1.0.0-rc2] - 2018-09-23 Изменено apps/enfist: вместо pgrpc-sql-enfist теперь используется apisite Установка обновления 1 2 3 4 5 git pull mv .env .env.bak make init make enfist-apply make up [1.0.0-rc1] - 2017-10-22 Изменено apps/traefik*: в настройки вынесен редирект 80 -\u0026gt; 443 apps/traefik теперь не совместим по конфигу с apps/traefik-acme, при переключении необходим make init apps/cis: добавлено создание каталогов var/apps, var/log в cis-apply apps/cis: изменена версия webtail (0.12) apps/enfist: исправлено обновление sql-пакетов enfist,rpc и их текущие версии Добавлено Файл CHANGELOG.md README.md: информация о зависимости (gawk), уточнен блок \u0026ldquo;Быстрый старт\u0026rdquo; DEPLOY.md: блоки \u0026ldquo;Информация для разработчика\u0026rdquo;, \u0026ldquo;Удаление деплоя\u0026rdquo; Makefile: поддержка параметров PG_PORT_LOCAL, CFG_BAK Установка обновления 1 2 3 4 5 6 7 8 9 10 git pull mv .env .env.bak make init # Тут будет предупреждение об устаревшей версии webtail - надо изменить на новую в .env make enfist-apply # Сообщения \u0026#34;ERROR: Newest lib version (0.1) loaded already\u0026#34; игнорируем, других ошибок быть не должно make dc CMD=\u0026#34;up -d webtail\u0026#34; [0.1] - 2017-08-11 Move to dcape project, code working in general, commit\n[0.0.2] - 2015-02-12 Github: fidm Commit: init Last commit: 2018-08-15 Начало разработки аналога fig, утилиты для управления контейнерами Docker, которая была доступна на сайте fig.sh.\n[0.0.1] - 2014-11-12 Github: consup Commit: init Last commit: 2017-09-27 Начало работ по построению решения для автоматизации использования контейнеров docker.\n","description":"","id":27,"section":"dcape","tags":null,"title":"История изменений","uri":"https://dopos.github.io/dcape/changelog/"}]